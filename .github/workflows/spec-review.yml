name: OOXML Spec Compliance Review

on:
  pull_request:
    paths:
      - 'packages/super-editor/src/core/super-converter/v3/handlers/**'

jobs:
  spec-review:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4 # shallow-clone as default

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Claude Code
        run: npm install -g @anthropic-ai/claude-code

      - name: Get changed files
        id: changed
        run: |
          FILES=$(gh pr diff ${{ github.event.pull_request.number }} --name-only | grep 'v3/handlers/' || true)
          echo "files<<EOF" >> $GITHUB_OUTPUT
          echo "$FILES" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Review for spec compliance
        if: steps.changed.outputs.files != ''
        id: review
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Skip if API key not configured
          if [ -z "$ANTHROPIC_API_KEY" ]; then
            echo "ANTHROPIC_API_KEY not set, skipping review"
            exit 0
          fi

          # Configure MCP server
          claude mcp add --transport http ecma-spec https://api.ooxml.dev/mcp

          # Get the diff for review
          gh pr diff ${{ github.event.pull_request.number }} > /tmp/pr-diff.txt

          # Run Claude Code review with structured output format
          REVIEW=$(claude --print "You are reviewing a PR for OOXML spec compliance in the SuperDoc project.

          The changed files are OOXML element handlers that convert between XML and ProseMirror JSON.

          Use the ecma-spec MCP tools to look up relevant spec sections for any OOXML elements being handled.

          Review the diff and check:
          1. Are OOXML elements handled according to the ECMA-376 spec?
          2. Are any required attributes missing?
          3. Are there any spec violations or edge cases not handled?
          4. Are any non-existent attributes being referenced?

          OUTPUT FORMAT (use exactly this structure):

          ### Status
          - [ ] PASS - No spec violations found
          - [ ] FAIL - Spec violations detected

          (Check exactly ONE of the above)

          ### Changed Files
          (list files reviewed)

          ### Findings
          (If FAIL, list each issue briefly. Keep it concise - one line per issue.)

          | Element | Issue | Location |
          |---------|-------|----------|
          | w:element | Brief description of the problem | file.js:123 |

          ### Recommendation
          (Brief fix suggestion, or 'No action required' if passing)

          IMPORTANT:
          - Keep findings BRIEF - just identify the problem, don't explain the full spec
          - Do NOT include lengthy spec quotations in the output
          - Users can look up spec details at https://ooxml.dev/spec

          ---

          Changed files:
          ${{ steps.changed.outputs.files }}

          Diff:
          $(cat /tmp/pr-diff.txt)")

          # Save review output
          echo "$REVIEW" > /tmp/review-raw.txt

          # Check if review found violations
          if echo "$REVIEW" | grep -q "\[x\] FAIL"; then
            echo "has_violations=true" >> $GITHUB_OUTPUT
          else
            echo "has_violations=false" >> $GITHUB_OUTPUT
          fi

          # Build comment
          {
            echo "## OOXML Spec Compliance Review"
            echo
            printf '%s\n' "$REVIEW"
            echo
            echo "---"
            echo "Look up elements in the spec: [ooxml.dev/spec](https://ooxml.dev/spec)"
          } > /tmp/review-comment.md

          echo "review<<EOF" >> $GITHUB_OUTPUT
          echo "$REVIEW" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Post review comment
        if: steps.review.outputs.review != ''
        run: |
          gh pr comment ${{ github.event.pull_request.number }} --body-file /tmp/review-comment.md
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Fail if violations found
        if: steps.review.outputs.has_violations == 'true'
        run: |
          echo "::error::OOXML spec violations detected. See PR comment for details."
          exit 1
